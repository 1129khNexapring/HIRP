<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="SurveyMapper">
	<resultMap type="Survey" id="surveyResultMap">
		<id property="surveyNo" column="SURVEY_NO"/>
		<result property="surveyTitle" column="SURVEY_TITLE"/>
		<result property="surveyWriter" column="SURVEY_WRITER"/>
		<result property="surveyDate" column="SURVEY_DATE"/>
		<result property="surveyUpdate" column="SURVEY_UPDATE"/>
		<result property="surveyStatus" column="SURVEY_STATUS"/>
		<result property="surveyStartdate" column="SURVEY_STARTDATE"/>
		<result property="surveyEnddate" column="SURVEY_ENDDATE"/>
		<result property="surveyResult" column="SURVEY_RESULT"/>
		<result property="surveyEdit" column="SURVEY_EDIT"/>
		<result property="surveyStartcomment" column="SURVEY_STARTCOMMENT"/>
		<result property="surveyStorage" column="SURVEY_STORAGE"/>
	</resultMap>
	
	<resultMap type="SurveyMyStatus" id="surveyMyStatusResultMap">
		<id property="surveyNo" column="SURVEY_NO"/>
		<result property="surveyTitle" column="SURVEY_TITLE"/>
		<result property="surveyWriter" column="SURVEY_WRITER"/>
		<result property="surveyDate" column="SURVEY_DATE"/>
		<result property="surveyUpdate" column="SURVEY_UPDATE"/>
		<result property="surveyStatus" column="SURVEY_STATUS"/>
		<result property="surveyStartdate" column="SURVEY_STARTDATE"/>
		<result property="surveyEnddate" column="SURVEY_ENDDATE"/>
		<result property="surveyResult" column="SURVEY_RESULT"/>
		<result property="surveyEdit" column="SURVEY_EDIT"/>
		<result property="surveyStartcomment" column="SURVEY_STARTCOMMENT"/>
		<result property="surveyStorage" column="SURVEY_STORAGE"/>
		<result property="subAnswerstatus" column="SUB_ANSWERSTATUS"/>
	</resultMap>
	
	<resultMap type="SurveySub" id="surveySubResultMap">
		<id property="subNo" column="SUB_NO"/>
		<result property="surveyNo" column="SURVEY_NO"/>
		<result property="subId" column="SUB_ID"/>
		<result property="subAnswerstatus" column="SUB_ANSWERSTATUS"/>
	</resultMap>
	
	<resultMap type="SurveySubEmpl" id="SurveySubEmplResultMap">
		<id property="subNo" column="SUB_NO"/>
		<result property="surveyNo" column="SURVEY_NO"/>
		<result property="subId" column="SUB_ID"/>
		<result property="subAnswerstatus" column="SUB_ANSWERSTATUS"/>
		<result property="deptCode" column="DEPT_CODE"/>
		<result property="deptName" column="DEPT_NAME"/>
		<result property="positionCode" column="POSITION_CODE"/>
		<result property="positionName" column="POSITION_NAME"/>
		<result property="emplName" column="EMPL_NAME"/>
	</resultMap>
	
	<resultMap type="SurveyQuest" id="SurveyQuestResultMap">
		<id property="questNo" column="QUEST_NO"/>
		<result property="surveyNo" column="SURVEY_NO"/>
		<result property="questTitle" column="QUEST_TITLE"/>
		<result property="questType1" column="QUEST_TYPE1"/>
		<result property="questType2" column="QUEST_TYPE2"/>
		<result property="questRequired" column="QUEST_REQUIRED"/>
	</resultMap>
	
	<resultMap type="SurveyQuestCh" id="SurveyQuestChResultMap">
		<id property="surveyquestNo" column="SURVEYQUEST_NO"/>
		<result property="surveyCh1" column="SURVEY_CH1"/>
		<result property="surveyCh2" column="SURVEY_CH2"/>
		<result property="surveyCh3" column="SURVEY_CH3"/>
		<result property="surveyCh4" column="SURVEY_CH4"/>
		<result property="surveyChmax" column="SURVEY_CHMAX"/>
	</resultMap>
	
	<!-- 설문조사 최신(최대 출력 개수 지정) + 내 응답여부 (조인 사용) -->
	<!-- resultmap을 사용하더라도 꼭 domain에 있는 모든 컬럼을 가져올 필요는 없음. -->
	<select id="selectAllSurvey" resultMap="surveyMyStatusResultMap">
		SELECT SURVEY_NO, SURVEY_TITLE, SURVEY_WRITER, SURVEY_DATE, SURVEY_UPDATE, SURVEY_STATUS,
		SURVEY_STARTDATE, SURVEY_ENDDATE, SURVEY_RESULT, SURVEY_EDIT, SURVEY_STARTCOMMENT, SURVEY_STORAGE,
		SUB_ANSWERSTATUS
		FROM SURVEY_TBL
		LEFT JOIN (SELECT * FROM SURVEY_SUB WHERE SUB_ID = #{emplId}) USING(SURVEY_NO)
		<![CDATA[WHERE ROWNUM <=10]]>
		ORDER BY SURVEY_NO DESC
	</select>
	<!-- 진행중인 리스트 조회 -->
	<select id="selectProceedSurvey" resultMap="surveyMyStatusResultMap">
		SELECT SURVEY_NO, SURVEY_TITLE, SURVEY_WRITER, SURVEY_DATE, SURVEY_UPDATE, SURVEY_STATUS,
		SURVEY_STARTDATE, SURVEY_ENDDATE, SURVEY_RESULT, SURVEY_EDIT, SURVEY_STARTCOMMENT, SURVEY_STORAGE,
		SUB_ANSWERSTATUS
		FROM SURVEY_TBL
		LEFT JOIN (SELECT * FROM SURVEY_SUB WHERE SUB_ID = #{emplId}) USING(SURVEY_NO)
		<![CDATA[WHERE SURVEY_STATUS = 'C' AND ROWNUM <=10]]>
		ORDER BY SURVEY_NO DESC
	</select>
	<!-- 마감된 리스트 조회 -->
	<select id="selectClosedSurvey" resultMap="surveyMyStatusResultMap">
		SELECT SURVEY_NO, SURVEY_TITLE, SURVEY_WRITER, SURVEY_DATE, SURVEY_UPDATE, SURVEY_STATUS,
		SURVEY_STARTDATE, SURVEY_ENDDATE, SURVEY_RESULT, SURVEY_EDIT, SURVEY_STARTCOMMENT, SURVEY_STORAGE,
		SUB_ANSWERSTATUS
		FROM SURVEY_TBL
		LEFT JOIN (SELECT * FROM SURVEY_SUB WHERE SUB_ID = #{emplId}) USING(SURVEY_NO)
		<![CDATA[WHERE SURVEY_STATUS = 'F' AND ROWNUM <=10]]>
		ORDER BY SURVEY_NO DESC
	</select>
	<!-- 내가 작성한 설문 리스트 조회 -->
	<select id="selectWroteSurvey" resultMap="surveyResultMap">
		SELECT * FROM SURVEY_TBL WHERE SURVEY_WRITER = #{emplId} ORDER BY SURVEY_NO DESC
	</select>
	<!-- 내가 대상자이면서 응답하지 않은 것 중 진행중인 설문 리스트 조회 -->
	<select id="selectSubSurveyById" resultMap="surveyResultMap">
		SELECT * FROM SURVEY_TBL
		JOIN (SELECT SURVEY_NO FROM SURVEY_SUB WHERE SUB_ID = #{emplId} AND SUB_ANSWERSTATUS='N')
		USING(SURVEY_NO)
		WHERE SURVEY_STATUS = 'C'
	</select>
	<!-- 설문조사 대상자 리스트 가져오기(응답여부 확인 가능) -->
	<select id="selectSurveySubByNo" resultMap="SurveySubEmplResultMap">
		SELECT SUB_NO, SURVEY_NO, SUB_ID, SUB_ANSWERSTATUS,
		DEPT_CODE, C.DEPT_NAME, POSITION_CODE, POSITION_NAME, EMPL_NAME
		FROM SURVEY_SUB A
		JOIN EMPL_TBL B ON A.SUB_ID = B.EMPL_ID
		JOIN DEPT_TBL C USING(DEPT_CODE)
		JOIN POSITION_TBL D USING(POSITION_CODE)
		WHERE SURVEY_NO = #{surveyNo}
	</select>
	<!-- 현재 설문조사 시퀀스 번호 가져오기 -->
	<select id="selectSurveySeqNo" resultType="_int">
		SELECT SURVEY_SEQ.CURRVAL FROM DUAL
	</select>
	
	<!-- 설문조사 추가 -->
	<insert id="insertSurvey">
		INSERT INTO SURVEY_TBL
		VALUES(SURVEY_SEQ.NEXTVAL, #{surveyTitle}, #{surveyWriter}, 
		DEFAULT, DEFAULT, 'C', 
		#{surveyStartdate}, #{surveyEnddate}, 
		#{surveyResult}, #{surveyEdit}, NULL, DEFAULT)
	</insert>
	<!-- 설문조사 수정 -->
	<update id="updateSurvey">
		UPDATE SURVEY_TBL SET SURVEY_STARTCOMMENT = #{surveyStartcomment} 
		WHERE SURVEY_NO = #{surveyNo}
	</update>
	<!-- 설문 문항 추가 -->
	<insert id="insertSurveyQuest">
		INSERT INTO SURVEY_QUEST 
		VALUES(SURVEYQUEST_SEQ.NEXTVAL, SURVEY_SEQ.CURRVAL,
		#{questTitle}, #{questType1}, #{questType2}, DEFAULT)
	</insert>
	<!-- 설문 보기 추가 -->
	<insert id="insertSurveyQuestCh">
		INSERT INTO SURVEYQUEST_CH
		VALUES(SURVEYQUEST_SEQ.CURRVAL, 
		#{surveyCh1}, #{surveyCh2}, #{surveyCh3}, #{surveyCh4}, #{surveyChmax})
	</insert>
</mapper>